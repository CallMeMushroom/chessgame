# 中国象棋

[Github](https://github.com/CallMeMushroom/chessgame) | [“象棋”中文维基百科](https://zh.wikipedia.org/wiki/%E8%B1%A1%E6%A3%8B) | [wikipedia](https://en.wikipedia.org/wiki/Xiangqi)

在中国，这是简直不能再通俗的游戏了，随便抓个老大爷还是小学生下的都比我好。  
不幸的是，这个软件似乎 **只支持本地的双人模式** ，想打败村口老大爷还是有点难啊（悲）

## 操作说明

### 鼠标

- 左键单击选中棋子，或选中棋子后选择其落点
- 右键单击任意位置取消选中
- 此外，<kbd>Ctrl</kbd> + <kbd>中键</kbd> 会退出游戏。

### 键盘

- <kbd>Ctrl</kbd> + <kbd>Z</kbd> ：撤销上一步，可以连续撤销。
  - 大部分情况下是悔棋，虽说“落子无悔”，但万一手抖了呢？
- <kbd>Ctrl</kbd> + <kbd>Y</kbd> ：未实装。
- <kbd>Ctrl</kbd> + <kbd>S</kbd> ：把当前局面保存在内存中。
  - 象棋不是ギャルゲー，就算能存盘，你也只能有一个存档位。在存盘时，旧的存档（如果有）会被覆盖。
- <kbd>Ctrl</kbd> + <kbd>L</kbd> ：读取内存中的局面。可以用 <kbd>Ctrl</kbd> + <kbd>Z</kbd> 撤销。
- <kbd>Ctrl</kbd> + <kbd>E</kbd> ：将当前盘面导出到剪贴板。
- <kbd>Ctrl</kbd> + <kbd>I</kbd> ：如果合法，把剪贴板内的盘面导入到棋盘。
  - 无论导出时状态如何，导入时总是红方行棋。
  - 可以用这个功能来推演排局。
- <kbd>Ctrl</kbd> + <kbd>R</kbd> ：~~掀桌~~ 把局面恢复到初始状态。可以用 <kbd>Ctrl</kbd> + <kbd>Z</kbd> 撤销。
- <kbd>Ctrl</kbd> + <kbd>W</kbd> 或 <kbd>Esc</kbd> ：退出游戏。

## 核心机制

好吧，虽然一开始我想复刻象棋完整规则，但是现在看来似乎有些难度。

- 合法行棋判定
  - 可以说是最基础的逻辑了。如果行棋后会导致你被将军（当然，将军不应将也会），会有奇怪的提示音告诉你这步棋是不合法的。
- 将杀判定。虽然做出来了，但十分粗糙。
  - 如果某方形成了绝杀，那么你会看到被杀方的将/帅变成了……一个“蘑”字(?)
  - 在盘面上棋子数量较多的时候，要近两秒才能爆搜完毕确定将杀。（这里有很大改进空间，确切算法也有了，但没太多时间码代码了）
  - 困毙和此判定同理。因此没有特判困毙。
- 其他。如长将判负等
  - **完全没有**此功能
  - 理由是，即使优化了算法，“长杀”判定的时间复杂度也是爆搜无法接受的。因为实战中会出现一方长杀、一方长将的情况（这种情况下本应判为和棋），如果直接判为长将方败显然有失公正。
  - 此外，同为长禁着的“长捉”的概念涉及到多回合搜索、甚至是子力价值模型（以区别于邀兑）。在没有模型的情况下**完全无法**在合理时间复杂度内实现。因此我放弃了这方面功能的开发。

## 美术、音效、以及动画

- 棋盘、棋子等均为利用 `EasyX` 自带绘图函数绘制。
  - 棋子上汉字的字体为王漢宗魏碑繁，该字体基于 [`GNU GPLv3`](https://www.gnu.org/licenses/gpl-3.0.txt) 协议发布。字体安装文件已附于程序内。
- 选中、移动、吃子、将军、将杀均有不同的音效。音效可以关闭。
  - 部分音效取自于 [`freesound.org`](https://freesound.org/)，基于 [`CC-BY-NC-3.0`](https://creativecommons.org/licenses/by-nc/3.0/) 发布、或发布于公有领域。某同学帮我对音源进行了剪辑。
  - 另有部分音效由我自己录制。某同学帮我进行了剪辑。
- 移动棋子时会有一个非常朴素的动画。动画的具体参数可以修改。动画效果也可以关闭。
  - 如果 `ANIME_DUR_SEC` 设置过大，或 `ANIME_FREQ_HZ` 设置过小，可能会导致糟糕的动画效果。
  - 已知BUG：棋子在动画中越过另一棋子时会有奇怪的表现。

## 附：关于“合法盘面”

- 一个“合法的盘面”指，一个长度恰好为90的字符串，只包含不区分大小写的 `R` , `H` , `B` , `A` , `G` , `C` , `P` 和/或 空格字符 。且 `G` 和 `g` 均恰好各有一个。
- 从该字符串的第一个字符算起，每恰好9个字符成为一“行”，共10“行”；在每个以此法划分的“行”中，每个字符均独立代表一个交叉点的状态。
  - 对于整个棋盘来说，每一“行”都分别代表棋盘上某一行的状态。第一“行”代表从上往下第一行的状态，第二“行”代表从上往下第二行的状态，以此类推。
  - 对棋盘上的每一行来说，对应“行”的每一个字符都分别代表棋盘上某一交叉点的状态。第一个字符代表该行从左至右第一个交叉点的状态，第二个字符代表从左至右第二个交叉点的状态，以此类推。
  - `R` 为 `Rook`，代表 `車`；`H` 为 `Horse`，代表 `馬`；`B` 为 `Bishop`，代表 `相`或`象`；`A` 为 `Advisor`，代表 `仕`或`士`；`G` 为 `Governor` 或 `General`，代表 `帥`或`將`；`C` 为 `Cannon` 或 `Catapult`，代表 `炮`或`砲`；`P` 为 `Pawn`，代表 `兵`或`卒`。此外，空格字符代表此交叉点上并无任何棋子。
  - 以上棋子，均遵守“大写字母代表红方棋子、小写字母代表黑方棋子”的规则。
- 暂时并没有对帥/將、仕/士、相/象、兵/卒的位置做出合理性限制。当心别玩坏了。
